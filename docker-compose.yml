
name: sep490
services:
  discovery-server:
    build:
      context: ./discovery-server
    image: ${IMAGE_PREFIX:-local}/discovery-server:${IMAGE_TAG:-dev}
    container_name: discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DISCOVERY_PORT: ${DISCOVERY_PORT:-8761}
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
    ports:
      - "${DISCOVERY_PORT:-8761}:8761"
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://localhost:8761/actuator/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
    networks: [sep490-net]

  # service Redis
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6380:6379"
    networks: [ sep490-net ]

  # rookie-service
  rookie-service:
    build:
      context: ./rookie-service
    image: ${IMAGE_PREFIX:-local}/rookie-service:${IMAGE_TAG:-dev}
    container_name: rookie-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      ROOKIE_PORT: ${ROOKIE_PORT:-8081}
      EUREKA_URL: http://discovery-server:8761/eureka
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
      # === DB cho container ===
      DB_URL: jdbc:sqlserver://mssql:1433;databaseName=rookie_db;encrypt=true;trustServerCertificate=true
      DB_USERNAME: sa
      DB_PASSWORD: ${MSSQL_SA_PASSWORD}
      DB_DRIVER: com.microsoft.sqlserver.jdbc.SQLServerDriver

      # === Redis trong container ===
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      discovery-server:
        condition: service_started
      mssql:
        condition: service_started
      redis:
        condition: service_started
    ports:
      - "${ROOKIE_PORT:-8081}:8081"
    networks: [sep490-net]

  # ai-service
  ai-service:
    build:
      context: ./ai-service
    image: ${IMAGE_PREFIX:-local}/ai-service:${IMAGE_TAG:-dev}
    container_name: ai-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      AI_PORT: ${AI_PORT:-8082}
      EUREKA_URL: http://discovery-server:8761/eureka
      TZ: ${TZ:-Asia/Ho_Chi_Minh}

      DB_URL: jdbc:sqlserver://mssql:1433;databaseName=rookie_db;encrypt=true;trustServerCertificate=true
      DB_USERNAME: sa
      DB_PASSWORD: ${MSSQL_SA_PASSWORD}
      DB_DRIVER: com.microsoft.sqlserver.jdbc.SQLServerDriver

      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      discovery-server:
        condition: service_started
      mssql:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "${AI_PORT:-8082}:8082"
    networks: [sep490-net]

  # ar-service
  ar-service:
    build:
      context: ./ar-service
    image: ${IMAGE_PREFIX:-local}/ar-service:${IMAGE_TAG:-dev}
    container_name: ar-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      AR_PORT: ${AR_PORT:-8083}
      EUREKA_URL: http://discovery-server:8761/eureka
      TZ: ${TZ:-Asia/Ho_Chi_Minh}

      DB_URL: jdbc:sqlserver://mssql:1433;databaseName=rookie_db;encrypt=true;trustServerCertificate=true
      DB_USERNAME: sa
      DB_PASSWORD: ${MSSQL_SA_PASSWORD}
      DB_DRIVER: com.microsoft.sqlserver.jdbc.SQLServerDriver

      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      discovery-server:
        condition: service_started
      mssql:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "${AR_PORT:-8083}:8083"
    networks: [sep490-net]

  api-gateway:
    build:
      context: ./api-gateway
    image: ${IMAGE_PREFIX:-local}/api-gateway:${IMAGE_TAG:-dev}
    container_name: api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      GATEWAY_PORT: ${GATEWAY_PORT:-8080}
      EUREKA_URL: http://discovery-server:8761/eureka
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    depends_on:
      discovery-server:
        condition: service_started
      rookie-service:
        condition: service_started
      ai-service:
        condition: service_started
      ar-service:
        condition: service_started
    networks: [sep490-net]

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_PID: "Express"
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    healthcheck:
      test: [ "CMD-SHELL","/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$${SA_PASSWORD}\" -No -Q \"SELECT 1\" -C || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 30
    networks: [ sep490-net ]

  mssql-bootstrap:
    image: mcr.microsoft.com/mssql/server:2022-latest
    depends_on:
      mssql:
        condition: service_healthy
    entrypoint: [ "/bin/bash","-lc" ]
    command:
      - >
        /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$${SA_PASSWORD}" -C
        -Q "IF DB_ID('rookie_db') IS NULL CREATE DATABASE rookie_db;"
    environment:
      SA_PASSWORD: ${MSSQL_SA_PASSWORD}
    networks: [ sep490-net ]
    restart: "no"


networks:
  sep490-net:
    driver: bridge

volumes:
  mssql_data:
  uploads_data:
